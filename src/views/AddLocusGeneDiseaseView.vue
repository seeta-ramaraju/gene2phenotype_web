<script>
import GeneInformation from "../components/curation/GeneInformation.vue";
import Publication from "../components/curation/Publication.vue";
import ClinicalPhenotype from "../components/curation/ClinicalPhenotype.vue";
import Genotype from "../components/curation/Genotype.vue";
import VariantInformation from "../components/curation/VariantInformation.vue";
import Mechanism from "../components/curation/Mechanism.vue";
import Disease from "../components/curation/Disease.vue";
import Panel from "../components/curation/Panel.vue";
import Confidence from "../components/curation/Confidence.vue";

export default {
  data() {
    return {
      input: {
        locus: "",
        session_name: "",
        publications: [],
        phenotypes: [],
        allelic_requirement: "",
        cross_cutting_modifier: [],
        variant_types: [],
        variant_descriptions: [],
        variant_consequences: [],
        molecular_mechanism: {},
        mechanism_synopsis: {},
        mechanism_evidence: [],
        disease: { disease_name: "", cross_references: [] },
        panels: [],
        confidence: {
          justification: "",
          level: "",
        },
      },
      isGeneDataLoading: false,
      isSubmitDataLoading: false,
      geneData: null,
      geneFunctionData: null,
      attributesData: null,
      geneErrorMsg: null,
      submitErrorMsg: null,
      submitSuccessMsg: null,
      publicationsErrorMsg: null,
      isPublicationsDataLoading: false,
      publicationsData: null,
      panelErrorMsg: null,
      isPanelDataLoading: false,
      panelData: null,
    };
  },
  components: {
    GeneInformation,
    Publication,
    ClinicalPhenotype,
    Genotype,
    VariantInformation,
    Mechanism,
    Disease,
    Panel,
    Confidence,
  },
  methods: {
    fetchInitialData() {
      this.fetchGeneInformation();
      this.fetchGeneDiseaseInformation();
      this.fetchPanels();
    },
    fetchGeneInformation() {
      this.geneErrorMsg =
        this.geneFunctionData =
        this.geneData =
        this.attributesData =
          null;
      this.isGeneDataLoading = true;
      Promise.all([
        fetch(`/gene2phenotype/api/gene/${this.input.locus}/function/`),
        fetch(`/gene2phenotype/api/gene/${this.input.locus}/`),
        fetch("/gene2phenotype/api/attribs/"),
      ])
        .then((responseArr) => {
          return Promise.all(
            responseArr.map((response) => {
              if (response.status === 200) {
                return response.json();
              } else {
                return Promise.reject(new Error("Unable to fetch gene data"));
              }
            })
          );
        })
        .then((responseJsonArr) => {
          const [geneFunctionData, geneData, attributesData] = responseJsonArr;
          this.isGeneDataLoading = false;
          this.geneData = geneData;
          this.geneFunctionData = geneFunctionData;
          this.attributesData = attributesData;
        })
        .catch((error) => {
          this.isGeneDataLoading = false;
          this.geneErrorMsg = error.message;
          console.log(error);
        });
    },
    fetchGeneDiseaseInformation() {
      this.geneDiseaseErrorMsg = this.geneDiseaseData = null;
      this.isGeneDiseaseDataLoading = true;
      fetch(`/gene2phenotype/api/gene/${this.input.locus}/disease`)
        .then((response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            return Promise.reject(
              new Error("Unable to fetch gene disease data")
            );
          }
        })
        .then((responseJson) => {
          this.isGeneDiseaseDataLoading = false;
          this.geneDiseaseData = responseJson;
        })
        .catch((error) => {
          this.isGeneDiseaseDataLoading = false;
          this.geneDiseaseErrorMsg = error.message;
          console.log(error);
        });
    },
    fetchPanels() {
      this.panelErrorMsg = this.panelData = null;
      this.isPanelDataLoading = true;
      fetch("/gene2phenotype/api/panels/")
        .then((response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            return Promise.reject(new Error("Unable to fetch panel data"));
          }
        })
        .then((responseJson) => {
          this.isPanelDataLoading = false;
          this.panelData = responseJson;
        })
        .catch((error) => {
          this.isPanelDataLoading = false;
          this.panelErrorMsg = error.message;
          console.log(error);
        });
    },
    fetchPublications(inputPmids) {
      this.publicationsErrorMsg = this.publicationsData = null;
      this.isPublicationsDataLoading = true;
      let pmidList = inputPmids.split(";").join(",");
      pmidList = pmidList.substring(0, pmidList.length - 1);
      fetch(`/gene2phenotype/api/publication/${pmidList}/`)
        .then((response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            return Promise.reject(
              new Error("Unable to fetch publications data")
            );
          }
        })
        .then((responseJson) => {
          this.isPublicationsDataLoading = false;
          this.publicationsData = responseJson;
        })
        .catch((error) => {
          this.isPublicationsDataLoading = false;
          this.publicationsErrorMsg = error.message;
          console.log(error);
        });
    },
    saveDraft() {
      console.log(this.input);
      this.submitErrorMsg = this.submitSuccessMsg = null;
      this.isSubmitDataLoading = true;
      fetch("/gene2phenotype/api/add/curation/", {
        method: "POST",
        body: JSON.stringify(this.input),
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
      })
        .then((response) => {
          if (response.status === 200) {
            return response.json();
          } else {
            return Promise.reject(new Error("Unable to submit data"));
          }
        })
        .then(() => {
          this.isSubmitDataLoading = false;
          this.submitSuccessMsg = "Curation Entry saved as draft successfully.";
        })
        .catch((error) => {
          this.isSubmitDataLoading = false;
          this.submitErrorMsg = error.message;
          console.log(error);
        });
    },
  },
};
</script>
<template>
  <div class="container px-5 py-3" style="min-height: 60vh">
    <h2>Add New G2P Record</h2>
    <form
      class="row g-3 pt-3 pb-1"
      @submit.prevent="fetchInitialData"
      v-if="!submitSuccessMsg"
    >
      <div class="col-auto">
        <label for="gene-symbol-input" class="col-form-label">Gene</label>
      </div>
      <div class="col-3">
        <input
          class="form-control"
          id="gene-symbol-input"
          v-model="input.locus"
        />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary mb-3">Search</button>
      </div>
    </form>
    <p v-if="!geneData">
      <i class="bi bi-info-circle"></i> Please enter Gene and click Search to
      proceed further.
    </p>
    <div
      class="d-flex justify-content-center"
      v-if="isGeneDataLoading || isSubmitDataLoading"
      style="margin-top: 250px; margin-bottom: 250px"
    >
      <div class="spinner-border text-secondary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="alert alert-danger mt-3" role="alert" v-if="geneErrorMsg">
      <div>
        <i class="bi bi-exclamation-circle-fill"></i> {{ geneErrorMsg }}
      </div>
    </div>
    <div
      id="curation-form-section"
      v-if="geneData && !isSubmitDataLoading && !submitSuccessMsg"
    >
      <GeneInformation
        :geneData="geneData"
        :geneFunctionData="geneFunctionData"
      />
      <Publication
        :fetchPublications="fetchPublications"
        :publicationsData="publicationsData"
        :isPublicationsDataLoading="isPublicationsDataLoading"
        :publicationsErrorMsg="publicationsErrorMsg"
        @update-publications="(valueArray) => (input.publications = valueArray)"
      />
      <ClinicalPhenotype
        :publicationsData="publicationsData"
        @update-clinical-phenotype="
          (valueArray) => (input.phenotypes = valueArray)
        "
      />
      <Genotype
        :attributesData="attributesData"
        v-model:allelic-requirement="input.allelic_requirement"
        @update-cross-cutting-modifiers="
          (valueArray) => (input.cross_cutting_modifier = valueArray)
        "
      />
      <VariantInformation
        :publicationsData="publicationsData"
        @update-variant-types="
          (valueArray) => (input.variant_types = valueArray)
        "
        @update-variant-descriptions="
          (valueArray) => (input.variant_descriptions = valueArray)
        "
        @update-variant-consequences="
          (valueArray) => (input.variant_consequences = valueArray)
        "
      />
      <Mechanism
        :publicationsData="publicationsData"
        :attributesData="attributesData"
        @update-molecular-mechanism="
          (valueObj) => (input.molecular_mechanism = valueObj)
        "
        @update-mechanism-synopsis="
          (valueObj) => (input.mechanism_synopsis = valueObj)
        "
        @update-mechanism-evidence="
          (valueArray) => (input.mechanism_evidence = valueArray)
        "
      />
      <Disease
        :inputGeneSymbol="input.locus"
        :geneDiseaseData="geneDiseaseData"
        :isGeneDiseaseDataLoading="isGeneDiseaseDataLoading"
        :geneDiseaseErrorMsg="geneDiseaseErrorMsg"
        @update-disease="(valueObj) => (input.disease = valueObj)"
      />
      <Panel
        :panelData="panelData"
        :isPanelDataLoading="isPanelDataLoading"
        :panelErrorMsg="panelErrorMsg"
        @update-panels="(valueArray) => (input.panels = valueArray)"
      />
      <Confidence
        :attributesData="attributesData"
        :inputPublications="input.publications"
        v-model:justification="input.confidence.justification"
        v-model:level="input.confidence.level"
      />
    </div>
    <div class="alert alert-danger mt-3" role="alert" v-if="submitErrorMsg">
      <div>
        <i class="bi bi-exclamation-circle-fill"></i> {{ submitErrorMsg }}
      </div>
    </div>
    <div
      class="d-flex justify-content-between py-3"
      v-if="geneData && !isSubmitDataLoading && !submitSuccessMsg"
    >
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        Save Draft
      </button>
      <button class="btn btn-primary">Publish</button>
    </div>
    <div
      class="alert alert-success mx-auto col-6"
      style="margin-top: 50px"
      role="alert"
      v-if="submitSuccessMsg"
    >
      <h4 class="alert-heading">
        <i
          class="bi bi-check-circle-fill"
          style="color: green; margin-right: 10px"
        ></i
        >Success
      </h4>
      <p>Curation record saved as draft.</p>
      <hr />
      <div class="d-flex justify-content-between">
        <router-link to="/curation/entries" class="btn btn-primary me-3">
          View All Saved Drafts
        </router-link>
        <router-link to="/lgd/add" class="btn btn-primary">
          Add Another G2P Record
        </router-link>
      </div>
    </div>
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Draft Submission</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3 py-3">
              <div class="col-3">
                <label for="session-name-input" class="col-form-label"
                  >Session Name (Optional)</label
                >
              </div>
              <div class="col">
                <input
                  class="form-control"
                  id="session-name-input"
                  v-model="input.session_name"
                />
              </div>
              <p>
                <i class="bi bi-info-circle"></i> If session name is not
                provided, an auto generated ID will be set as the session name.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              @click="saveDraft"
              data-bs-dismiss="modal"
            >
              Save Draft
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<style scoped>
h5 {
  font-weight: bold;
}
h6 {
  font-weight: bold;
}
</style>
